<TrustFrameworkPolicy xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance' xmlns:xsd='http://www.w3.org/2001/XMLSchema' xmlns='http://schemas.microsoft.com/online/cpim/schemas/2013/06' PolicySchemaVersion='0.3.0.0' 
  TenantId='yourtenant.onmicrosoft.com' 
  PolicyId='B2C_1A_IDP_AAD_Multi' 
  PublicPolicyUri='http://yourtenant.onmicrosoft.com/B2C_1A_IDP_AAD_Multi'>
  <BasePolicy>
    <TenantId>yourtenant.onmicrosoft.com</TenantId>
    <PolicyId>B2C_1A_TrustFrameworkExtensions</PolicyId>
  </BasePolicy>
 <ClaimsProviders>
  <ClaimsProvider>
  <Domain>commonaad</Domain>
  <DisplayName>Common AAD</DisplayName>
  <TechnicalProfiles>
    <TechnicalProfile Id='AADCommon-OpenIdConnect'>
      <DisplayName>M365 Login</DisplayName>
      <Description>Login with your M365 account</Description>
      <Protocol Name='OpenIdConnect'/>
      <Metadata>
        <Item Key='METADATA'>https://login.microsoftonline.com/common/v2.0/.well-known/openid-configuration</Item>
        <!-- Update the Client ID below to the Application ID -->
        <Item Key='client_id'>00000000-0000-0000-0000-000000000000</Item>
        <Item Key='response_types'>code</Item>
        <Item Key='scope'>openid profile</Item>
        <Item Key='response_mode'>form_post</Item>
        <Item Key='HttpBinding'>POST</Item>
        <Item Key='UsePolicyInRedirectUri'>false</Item>
        <Item Key='DiscoverMetadataByTokenIssuer'>true</Item>
        <!-- The key below allows you to specify each of the Azure AD tenants that can be used to sign in. Update the GUIDs below for each tenant. -->
        <Item Key='ValidTokenIssuerPrefixes'>https://login.microsoftonline.com/00000000-0000-0000-0000-000000000000</Item>
      </Metadata>
      <CryptographicKeys>
        <Key Id='client_secret' StorageReferenceId='B2C_1A_AADAppSecret'/>
      </CryptographicKeys>
      <OutputClaims>
        <OutputClaim ClaimTypeReferenceId='issuerUserId' PartnerClaimType='oid'/>
        <OutputClaim ClaimTypeReferenceId='tenantId' PartnerClaimType='tid'/>
        <OutputClaim ClaimTypeReferenceId='givenName' PartnerClaimType='given_name' />
        <OutputClaim ClaimTypeReferenceId='surName' PartnerClaimType='family_name' />
        <OutputClaim ClaimTypeReferenceId='displayName' PartnerClaimType='name' />
        <OutputClaim ClaimTypeReferenceId='authenticationSource' DefaultValue='socialIdpAuthentication' AlwaysUseDefaultValue='true' />
        <OutputClaim ClaimTypeReferenceId='identityProvider' PartnerClaimType='iss' />
      </OutputClaims>
      <OutputClaimsTransformations>
        <OutputClaimsTransformation ReferenceId='CreateRandomUPNUserName'/>
        <OutputClaimsTransformation ReferenceId='CreateUserPrincipalName'/>
        <OutputClaimsTransformation ReferenceId='CreateAlternativeSecurityId'/>
        <OutputClaimsTransformation ReferenceId='CreateSubjectClaimFromAlternativeSecurityId'/>
      </OutputClaimsTransformations>
      <UseTechnicalProfileForSessionManagement ReferenceId='SM-SocialLogin'/>
    </TechnicalProfile>
  </TechnicalProfiles>
</ClaimsProvider>
  </ClaimsProviders>
  <UserJourneys>
    <UserJourney Id='SignUpOrSignIn_Custom'>
      <OrchestrationSteps>
        <OrchestrationStep Order='1' Type='CombinedSignInAndSignUp' ContentDefinitionReferenceId='api.signuporsignin'>
          <ClaimsProviderSelections>
            <ClaimsProviderSelection TargetClaimsExchangeId='AzureADCommonExchange' />
            <ClaimsProviderSelection ValidationClaimsExchangeId='LocalAccountSigninEmailExchange' />
          </ClaimsProviderSelections>
          <ClaimsExchanges>
            <ClaimsExchange Id='LocalAccountSigninEmailExchange' TechnicalProfileReferenceId='SelfAsserted-LocalAccountSignin-Email' />
          </ClaimsExchanges>
        </OrchestrationStep>
        <OrchestrationStep Order='2' Type='ClaimsExchange'>
          <Preconditions>
            <Precondition Type='ClaimsExist' ExecuteActionsIf='true'>
              <Value>objectId</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
          </Preconditions>
          <ClaimsExchanges>
            <ClaimsExchange Id='AzureADCommonExchange' TechnicalProfileReferenceId='AADCommon-OpenIdConnect' />
            <ClaimsExchange Id='SignUpWithLogonEmailExchange' TechnicalProfileReferenceId='LocalAccountSignUpWithLogonEmail' />
          </ClaimsExchanges>
        </OrchestrationStep>
        <OrchestrationStep Order='3' Type='ClaimsExchange'>
          <Preconditions>
            <Precondition Type='ClaimEquals' ExecuteActionsIf='true'>
              <Value>authenticationSource</Value>
              <Value>localAccountAuthentication</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
          </Preconditions>
          <ClaimsExchanges>
            <ClaimsExchange Id='AADUserReadUsingAlternativeSecurityId' TechnicalProfileReferenceId='AAD-UserReadUsingAlternativeSecurityId-NoError' />
          </ClaimsExchanges>
        </OrchestrationStep>
        <OrchestrationStep Order='4' Type='ClaimsExchange'>
          <Preconditions>
            <Precondition Type='ClaimsExist' ExecuteActionsIf='true'>
              <Value>objectId</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
          </Preconditions>
          <ClaimsExchanges>
            <ClaimsExchange Id='SelfAsserted-Social' TechnicalProfileReferenceId='SelfAsserted-Social' />
          </ClaimsExchanges>
        </OrchestrationStep>
        <OrchestrationStep Order='5' Type='ClaimsExchange'>
          <Preconditions>
            <Precondition Type='ClaimEquals' ExecuteActionsIf='true'>
              <Value>authenticationSource</Value>
              <Value>socialIdpAuthentication</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
          </Preconditions>
          <ClaimsExchanges>
            <ClaimsExchange Id='AADUserReadWithObjectId' TechnicalProfileReferenceId='AAD-UserReadUsingObjectId' />
          </ClaimsExchanges>
        </OrchestrationStep>
        <OrchestrationStep Order='6' Type='ClaimsExchange'>
          <Preconditions>
            <Precondition Type='ClaimsExist' ExecuteActionsIf='true'>
              <Value>objectId</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
          </Preconditions>
          <ClaimsExchanges>
            <ClaimsExchange Id='AADUserWrite' TechnicalProfileReferenceId='AAD-UserWriteUsingAlternativeSecurityId' />
          </ClaimsExchanges>
        </OrchestrationStep>
        <OrchestrationStep Order='7' Type='SendClaims' CpimIssuerTechnicalProfileReferenceId='JwtIssuer' />
      </OrchestrationSteps>
      <ClientDefinition ReferenceId='DefaultWeb' />
    </UserJourney>
  </UserJourneys>
  <RelyingParty>
    <DefaultUserJourney ReferenceId='SignUpOrSignIn_Custom' />
    <TechnicalProfile Id='PolicyProfile'>
      <DisplayName>PolicyProfile</DisplayName>
      <Protocol Name='OpenIdConnect' />
      <OutputClaims>
        <OutputClaim ClaimTypeReferenceId='displayName' />
        <OutputClaim ClaimTypeReferenceId='givenName' />
        <OutputClaim ClaimTypeReferenceId='surname' />
        <OutputClaim ClaimTypeReferenceId="signInNames.emailAddress" PartnerClaimType="email" />
        <OutputClaim ClaimTypeReferenceId='objectId' PartnerClaimType='sub' />
        <OutputClaim ClaimTypeReferenceId='identityProvider' />
        <OutputClaim ClaimTypeReferenceId='tenantId' AlwaysUseDefaultValue='true' DefaultValue='{Policy:TenantObjectId}' />
      </OutputClaims>
      <SubjectNamingInfo ClaimType='sub' />
    </TechnicalProfile>
  </RelyingParty>
</TrustFrameworkPolicy>